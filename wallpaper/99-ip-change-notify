#!/bin/bash

# NetworkManager dispatcher script to detect IP address changes
# and update wallpaper information files

# Logging setup
LOG_FILE="/var/log/ip-change-notify.log"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Log EVERYTHING that comes in
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Log EVERY invocation - don't filter yet
log_message "=== SCRIPT INVOKED ==="
log_message "Interface: $1"
log_message "Action: $2"

# Get the actual user's home directory dynamically
# This finds the user who owns the X session (the logged-in desktop user)
ACTUAL_USER=$(who | grep '(:0)' | awk '{print $1}' | head -n 1)

# Fallback: if no X session found, try to get the user from the SUDO_USER environment
if [ -z "$ACTUAL_USER" ]; then
    ACTUAL_USER=$SUDO_USER
fi

# Fallback: if still empty, try loginctl
if [ -z "$ACTUAL_USER" ]; then
    ACTUAL_USER=$(loginctl list-sessions --no-legend | awk '{print $3}' | head -n 1)
fi

# Final fallback: default to pi4j if no user detected
if [ -z "$ACTUAL_USER" ]; then
    ACTUAL_USER="pi4j"
fi

log_message "Detected user: $ACTUAL_USER"

USER_HOME=$(eval echo ~$ACTUAL_USER)
WALLPAPER_DIR="$USER_HOME/wallpaper"

log_message "User home: $USER_HOME"
log_message "Wallpaper dir: $WALLPAPER_DIR"

# Ensure the wallpaper directory exists
mkdir -p "$WALLPAPER_DIR"
chown $ACTUAL_USER:$ACTUAL_USER "$WALLPAPER_DIR"

log_message "Wallpaper directory created/verified"

# Trigger wallpaper update using jbang
# Note: We need to run this with the user's full environment to access jbang
# The -l flag ensures the user's .bashrc/.profile are loaded with PATH
su -l $ACTUAL_USER -c "cd $WALLPAPER_DIR && ~/.sdkman/candidates/jbang/current/bin/jbang GenerateWallpaperInfoImage.java" 2>&1 | while IFS= read -r line; do
    log_message "JBang output: $line"
done

log_message "Script completed successfully"
exit 0